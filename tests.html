<!DOCTYPE html>
<html>
  <head>
    <title>Unit tests</title>
    <script type="module">
      import {onUnusedSubject} from './out/engine/assertions.js';
      import {run, logResults} from './out/engine/testing.js';
      import {AssertionsSuite} from './out/engine/tests/assertions.js';
      import {TestingSuite} from './out/engine/tests/testing.js';
      import {
        LinkedListSuite,
        MinheapSuite,
      } from './out/engine/tests/containers.js';

      const tests = [
        AssertionsSuite,
        TestingSuite,
        LinkedListSuite,
        MinheapSuite,
      ];

      function prettyName(name) {
        if (name.startsWith('test')) {
          name = name.substring('test'.length);
        } else if (name.endsWith('Suite')) {
          name = name.substring(0, name.length - 'Suite'.length);
        }
        return name.replace(
          /(?!^)([A-Z])/g,
          (_, letter) => ' ' + letter.toLowerCase()
        );
      }

      function logResult(result) {
        logResults(result);
        let suiteElement = document.querySelector(`.suite#${result.suite}`);
        if (!suiteElement) {
          const suiteTemplate = document.querySelector('.suite.template');
          suiteElement = suiteTemplate.cloneNode(true);
          suiteElement.classList.remove('template');
          suiteElement.id = result.suite;
          suiteElement.querySelector('.suiteName').innerText = prettyName(
            result.suite
          );
          suiteTemplate.parentElement.appendChild(suiteElement);
        }

        const testTemplate = suiteElement.querySelector('.template');
        /** @type HTMLDivElement */
        const testElement = testTemplate.cloneNode(true);
        testElement.classList.remove('template');
        testElement.classList.add(result.verdict);
        testElement.querySelector('.testName').innerText = prettyName(
          result.test
        );
        testElement.dataset.testName = result.test;
        testTemplate.parentElement.appendChild(testElement);

        const data = result.data ?? result.reason;
        /** @type HTMLDivElement */
        const reasonElement = testElement.querySelector('.reason');
        if (data instanceof HTMLElement) {
          reasonElement.appendChild(data);
        } else if (data) {
          reasonElement.innerText = `${data}`;
        } else {
          reasonElement.classList.add('hidden');
        }
      }

      /** @param {{suite: string, test: string}} context */
      function addWarning(context) {
        console.warn(
          `Unfinished (no-op) assertThat() in ${context.suite}.${context.test}.`
        );
        const testElement = document.querySelector(
          `.suite#${context.suite} [data-test-name="${context.test}"]`
        );
        /** @type HTMLDivElement | null */
        const warningsElement = testElement?.querySelector('.warnings');
        if (!warningsElement) {
          return;
        }

        const warning = document.createElement('div');
        warning.innerText = 'Test contains unfinished assertThat()';
        warningsElement.appendChild(warning);
        warningsElement.classList.remove('hidden');
      }

      window.addEventListener('load', async () => {
        onUnusedSubject(addWarning);
        await run(tests, logResult);
        document.querySelector('.spinnerContainer').remove();
      });
    </script>

    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Roboto+Mono&display=swap"
      rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Round"
      rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="tests.css" />
  </head>
  <body>
    <h1>Unit tests</h1>
    <div><i>See the console for stack traces.</i></div>
    <div>
      <div class="suiteContainer">
        <div class="suite template">
          <div class="suiteName"></div>
          <div class="testContainer">
            <div class="test template">
              <div class="testName"></div>
              <div class="reason"></div>
              <div class="warnings hidden"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="spinnerContainer">
        <span class="material-icons-round spinner">science</span>
      </div>
    </div>
  </body>
</html>
